Chapter 4, modified in experimental branch